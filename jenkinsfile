pipeline {
    environment {
        registry = "varavkoyv/deploying"
        registryCredential = "docker_hub"
        dockerImage = ""
        path_previos_file = "${WORKSPACE}/previos_dockerfile"
        path_file = "${WORKSPACE}/docker/Dockerfile"
        cheking = false
    }
    agent any
    stages {
        stage('Git_clone') {
            steps{
                git branch: 'main',
                     credentialsId: '96959a30-0a0a-439a-97c9-a23be67c7ac9', 
                     url: 'git@github.com:YuliyaVaravko/deploying.git'        
                }
        }

        stage('check Dockerfile') {
            steps{
                sh(script: ''' #!/bin/bash
                    hash_previous=sudo md5sum $path_previos_file
                    hash=sudo md5sum $path_file
                    if [ $hash -eq $hash_previous ]
                    then cheking=true
                    fi
                ''')
            }
        }
      
        stage('Build & push docker image') {
            when{expression{!cheking}}
                steps{ 
                    dir('docker/'){
                    script {
                        dockerImage = docker.build registry + ":$BUILD_NUMBER"
                        docker.withRegistry( '', registryCredential ) {
                            dockerImage.push()
                        }
                    }
                    sh (
                        cp $path_file $path_previos_file
                    )
                }
            }
        }

        stage('Ansible for script') {
            steps {
                dir('ansible/'){
                    ansiblePlaybook playbook: 'script.yml', inventory: 'inventory', credentialsId: 'ansible'
                }
            }
        }

        stage('Ansible for docker') {
            steps {
                dir('ansible/'){
                    ansiblePlaybook playbook: 'docker.yml', inventory: 'inventory', credentialsId: 'ansible', extras: '-e JENKINS_BUILD_NUMBER=$BUILD_NUMBER'
                }
            }
        }
    }
}
